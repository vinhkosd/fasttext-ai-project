import fasttext  # type: ignore
import re
import requests
from datetime import datetime, timezone, timedelta
from typing import Optional
from dateutil import parser, tz  # type: ignore
import dateutil  # type: ignore

# Load model
model = fasttext.load_model('models/intent_model.bin')
DUCKLING_URL = "http://localhost:8085/parse"
VI_LOCALE = "vi_VN"
TZ = timezone(timedelta(hours=7))  # Asia/Ho_Chi_Minh


# =============================
# âœ… xá»­ lÃ½ - / trong date
# =============================

def preprocess_date_text(text: str) -> str:
    """
    Chuáº©n hoÃ¡ chuá»—i ngÃ y thÃ¡ng ngÆ°á»i dÃ¹ng nháº­p Ä‘á»ƒ Duckling hiá»ƒu.
    - Nháº­n biáº¿t dáº¥u '-', '/', '.'
    - Chuáº©n hoÃ¡ 'thang' -> 'thÃ¡ng'
    - ThÃªm sá»‘ 0 cho ngÃ y/thÃ¡ng 1 chá»¯ sá»‘
    - Xá»­ lÃ½ tá»‘t cÃ¡c Ä‘á»‹nh dáº¡ng nhÆ°: '1-10', '1/10/2025', 'thang 1', 'thang 10 nam 2025'
    """
    text = text.lower().strip()

    # sá»­a lá»—i khÃ´ng dáº¥u: "thang" -> "thÃ¡ng", "nam" -> "nÄƒm"
    text = re.sub(r"\bthang\b", "thÃ¡ng", text)
    text = re.sub(r"\bnam\b", "nÄƒm", text)

    # Chuáº©n hoÃ¡ dáº¥u phÃ¢n cÃ¡ch vá» "/"
    text = re.sub(r"[-\.]", "/", text)

    # XoÃ¡ khoáº£ng tráº¯ng quanh "/"
    text = re.sub(r"\s*/\s*", "/", text)

    # ThÃªm sá»‘ 0 cho ngÃ y/thÃ¡ng ngáº¯n
    def pad_date_part(match):
        parts = match.group().split('/')
        parts = [p.zfill(2) if p.isdigit() else p for p in parts]
        return "/".join(parts)

    # Xá»­ lÃ½ dáº¡ng 2-2021, 2/2021 â†’ thÃ¡ng 2 nÄƒm 2021
    text = re.sub(r'\b(\d{1,2})[/-](\d{2,4})\b', r'thÃ¡ng \1 nÄƒm \2', text)

    # Xá»­ lÃ½ dáº¡ng viáº¿t táº¯t â€œt2-21â€ hoáº·c â€œt2/21â€ â†’ â€œthÃ¡ng 2 nÄƒm 2021â€
    text = re.sub(r'\bt\s*0*(\d{1,2})[/-](\d{2})\b', r'thÃ¡ng \1 nÄƒm 20\2', text)

    return text




# =============================
# âœ… HÃ m chuyá»ƒn mÃºi giá» (Ä‘Ã£ fix)
# =============================
def to_vn_timezone(dt_str: str):
    """Chuyá»ƒn ISO datetime string vá» mÃºi giá» Viá»‡t Nam (UTC+7).
    Tá»± Ä‘á»™ng +1 ngÃ y náº¿u Duckling tráº£ vá» giá» lÃ¹i (vd: -07:00 â†’ +07:00).
    """
    try:
        dt = parser.isoparse(dt_str)
        if dt.tzinfo is None:
            dt = dt.replace(tzinfo=timezone.utc)

        vn_tz = tz.gettz("Asia/Ho_Chi_Minh")
        vn_time = dt.astimezone(vn_tz)

        # TÃ­nh chÃªnh lá»‡ch giá» thá»±c táº¿ giá»¯a VN vÃ  gá»‘c Duckling
        diff_hours = (vn_tz.utcoffset(dt) - dt.utcoffset()).total_seconds() / 3600

        # Náº¿u lá»‡ch quÃ¡ 8 tiáº¿ng (vd. -07:00 â†’ +07:00)
        if diff_hours > 8:
            vn_time += timedelta(days=1)
            vn_time = vn_time.replace(hour=0, minute=0, second=0, microsecond=0)

        return vn_time
    except Exception as e:
        print(f"âš ï¸ to_vn_timezone error: {e}")
        return parser.isoparse(dt_str)


# =============================
# Gá»i Duckling
# =============================
def duckling_parse_time(text: str, ref_time: Optional[datetime] = None):
    text = preprocess_date_text(text)
    """Gá»i Duckling server Ä‘á»ƒ parse ngÃ y/giá»."""
    if ref_time is None:
        ref_time = datetime.now(TZ)
    print("Duckling Ä‘ang xá»­ lÃ­")
    reftime_ms = int(ref_time.timestamp() * 1000)

    data = {
        "locale": VI_LOCALE,
        "text": text,
        "dims": '["time"]',
        "reftime": str(reftime_ms),
    }
    try:
        r = requests.post(
            DUCKLING_URL,
            data=data,
            headers={"Content-Type": "application/x-www-form-urlencoded; charset=UTF-8"},
            timeout=5
        )
        r.raise_for_status()
        return r.json()
    except Exception as e:
        print("âš ï¸ Duckling error:", e)
        return []


# =============================
# CÃ¡c hÃ m há»— trá»£ xá»­ lÃ½ thá»i gian
# =============================
def _iso_to_dt(s: str) -> datetime:
    s = s.replace('Z', '+00:00')
    return datetime.fromisoformat(s)

def _to_iso(dt: datetime) -> str:
    return dt.isoformat()

def _add_months(dt: datetime, months: int) -> datetime:
    y = dt.year + (dt.month - 1 + months) // 12
    m = (dt.month - 1 + months) % 12 + 1
    return dt.replace(year=y, month=m, day=1, hour=0, minute=0, second=0, microsecond=0)

def _end_of_month(dt: datetime) -> datetime:
    first_next = _add_months(dt.replace(day=1, hour=0, minute=0, second=0, microsecond=0), 1)
    return first_next - timedelta(seconds=1)


# =============================
# Má»Ÿ rá»™ng khoáº£ng thá»i gian
# =============================
def _expand_grain_interval(val_iso: str, grain: str, inclusive_end: bool = True, tz: timezone = TZ):
    base = to_vn_timezone(val_iso)

    # Náº¿u giá» Viá»‡t Nam < 3h sÃ¡ng â†’ Duckling tÃ­nh ngÃ y hÃ´m trÆ°á»›c â†’ cá»™ng 1 ngÃ y
    if base.hour < 3:
        base = base + timedelta(days=1)

    if grain == "day":
        start = base.replace(hour=0, minute=0, second=0, microsecond=0)
        end = start + timedelta(days=1)
        if inclusive_end:
            end = end - timedelta(seconds=1)
        return _to_iso(start), _to_iso(end)

    if grain == "week":
        start = base.replace(hour=0, minute=0, second=0, microsecond=0)
        end = start + timedelta(days=7)
        if inclusive_end:
            end = end - timedelta(seconds=1)
        return _to_iso(start), _to_iso(end)

    if grain == "month":
        start = base.replace(day=1, hour=0, minute=0, second=0, microsecond=0)
        if inclusive_end:
            end_dt = _end_of_month(start)
        else:
            end_dt = _add_months(start, 1)
        return _to_iso(start), _to_iso(end_dt)

    if grain == "quarter":
        q = (base.month - 1) // 3
        start_month = q * 3 + 1
        start = base.replace(month=start_month, day=1, hour=0, minute=0, second=0, microsecond=0)
        if inclusive_end:
            end_dt = _add_months(start, 3) - timedelta(seconds=1)
        else:
            end_dt = _add_months(start, 3)
        return _to_iso(start), _to_iso(end_dt)

    if grain == "year":
        start = base.replace(month=1, day=1, hour=0, minute=0, second=0, microsecond=0)
        if inclusive_end:
            end_dt = start.replace(year=start.year + 1) - timedelta(seconds=1)
        else:
            end_dt = start.replace(year=start.year + 1)
        return _to_iso(start), _to_iso(end_dt)

    return val_iso, val_iso


# =============================
# Chuáº©n hÃ³a dá»¯ liá»‡u tá»« Duckling
# =============================
def normalize_duckling_times(resp: list, inclusive_end: bool = True, tz: timezone = TZ):
    if not resp:
        return {"type": "none"}

    # Náº¿u Duckling tráº£ vá» nhiá»u má»‘c thá»i gian (vÃ­ dá»¥: tá»« ngÃ y... Ä‘áº¿n ngÃ y...)
    if len(resp) >= 2:
        try:
            first_item = resp[0]
            last_item = resp[-1]
            first_val = first_item.get("value", {}).get("value")
            last_val = last_item.get("value", {}).get("value")
            first_grain = first_item.get("value", {}).get("grain", "day")
            last_grain = last_item.get("value", {}).get("grain", "day")

            if first_val and last_val:
                start, _ = _expand_grain_interval(first_val, first_grain, inclusive_end=False, tz=tz)
                _, end = _expand_grain_interval(last_val, last_grain, inclusive_end=True, tz=tz)
                return {"type": "range", "start": start, "end": end, "grain": last_grain}
        except Exception as e:
            print("âš ï¸ Multi-time normalize error:", e)

    # Chá»n item "time" chÃ­nh
    item = next((x for x in resp if x.get("dim") == "time"), resp[0])
    primary = None
    top_values = item.get("values")
    top_value = item.get("value")

    if isinstance(top_values, list) and top_values:
        primary = top_values[0]
    elif isinstance(top_value, dict):
        if isinstance(top_value.get("values"), list) and top_value["values"]:
            primary = top_value["values"][0]
        else:
            primary = top_value

    if not isinstance(primary, dict):
        return {"type": "none"}

    typ = primary.get("type")
    grain = primary.get("grain")

    # ğŸ•’ DÃ¹ng hÃ m to_vn_timezone Ä‘Ã£ fix
    if typ == "interval":
        start_iso = primary.get("from", {}).get("value")
        end_iso = primary.get("to", {}).get("value")

        if start_iso:
            start_iso = to_vn_timezone(start_iso).isoformat()
        if end_iso:
            end_iso = to_vn_timezone(end_iso).isoformat()

        if inclusive_end and end_iso:
            end_grain = primary.get("to", {}).get("grain") or grain or "day"
            if end_grain in ("day", "week", "month", "quarter", "year"):
                _s, end_iso = _expand_grain_interval(end_iso, end_grain, inclusive_end=True, tz=tz)

        return {"type": "range", "start": start_iso, "end": end_iso}

    if typ == "value":
        val_iso = primary.get("value")
        vn_dt = to_vn_timezone(val_iso)
        # GiÃºp cÃ¡c cÃ¢u nhÆ° "xem lÆ°Æ¡ng thÃ¡ng 3" â†’ hiá»ƒu lÃ  thÃ¡ng 3 nÄƒm 2025
        try:
            if not re.search(r'\b20\d{2}\b', item.get("body", "")):
                now = datetime.now(TZ)
                vn_dt = vn_dt.replace(year=now.year)
        except Exception as e:
            print("âš ï¸ Year defaulting error:", e)

        val_iso = vn_dt.isoformat()

        if grain in ("week", "month", "quarter", "year"):
            start, end = _expand_grain_interval(val_iso, grain, inclusive_end=inclusive_end, tz=tz)
            return {"type": "range", "start": start, "end": end, "grain": grain}
        return {"type": "single", "date": val_iso, "grain": grain}

    return {"type": "none"}



# =============================
# Intent handling (giá»¯ nguyÃªn)
# =============================
def build_response_with_time(text: str):
    intent, confidence = predict_intent(text)

    time_info = {"type": "none"}
    # Náº¿u intent liÃªn quan thá»i gian thÃ¬ gá»i Duckling
    if "NGAY" in intent:
        duck_resp = duckling_parse_time(text)
        print(duck_resp)
        time_info = normalize_duckling_times(duck_resp)

    action_text = get_action(intent, text)
    return {"intent": intent, "confidence": confidence, "time": time_info, "message": action_text}


def predict_intent(text):
    try:
        predictions = model.predict(text, k=1)
        intent = predictions[0][0].replace('__label__', '')
        confidence = predictions[1][0]
        return intent, confidence
    except Exception:
        return "UNKNOWN", 0.0


# =============================
# Ná»™i dung pháº£n há»“i ngÆ°á»i dÃ¹ng
# =============================
def get_action(intent, text=""):
    actions = {
        "WELCOME": """ChÃ o báº¡n nha! ğŸ‘‹ 
        TÃ´i cÃ³ thá»ƒ giÃºp báº¡n cÃ¡c viá»‡c sau:
        ğŸ“Š **Xem lÆ°Æ¡ng** - Xem báº£ng lÆ°Æ¡ng cÃ¡ nhÃ¢n
        ğŸ“… **Xem cháº¥m cÃ´ng** - Xem thÃ´ng tin cháº¥m cÃ´ng
        ğŸ‘¤ **Xem thÃ´ng tin cÃ¡ nhÃ¢n** - Xem há»“ sÆ¡ cÃ¡ nhÃ¢n
        ğŸ“‹ **Xem ngÃ y nghá»‰** - Xem thÃ´ng tin nghá»‰ phÃ©p

        ğŸ’¡ **VÃ­ dá»¥ cÃ¡ch há»i:**
        - "Cho tÃ´i xem lÆ°Æ¡ng thÃ¡ng nÃ y"
        - "Xem cháº¥m cÃ´ng tá»« 1/10 Ä‘áº¿n 31/10"  
        - "Hiá»ƒn thá»‹ thÃ´ng tin cÃ¡ nhÃ¢n"
        - "Cháº¥m cÃ´ng thÃ¡ng trÆ°á»›c"

        HÃ£y cho tÃ´i biáº¿t báº¡n cáº§n gÃ¬ nhÃ©! ğŸ˜Š""",
        
        "HELP_INFORMATION": """Xin chÃ o, tÃ´i lÃ  TimeAI! ğŸ¤–
        TÃ´i cÃ³ thá»ƒ giÃºp báº¡n nhá»¯ng thÃ´ng tin:
        â€¢ ğŸ“‹ **ThÃ´ng tin cÃ¡ nhÃ¢n** - Há» tÃªn, mÃ£ NV, phÃ²ng ban, chá»©c vá»¥
        â€¢ ğŸ“… **ThÃ´ng tin ngÃ y cÃ´ng** - Cháº¥m cÃ´ng, giá» lÃ m, tÄƒng ca  
        â€¢ ğŸ–ï¸ **ThÃ´ng tin ngÃ y nghá»‰** - PhÃ©p nÄƒm, ngÃ y váº¯ng
        â€¢ ğŸ’° **ThÃ´ng tin lÆ°Æ¡ng thÃ¡ng** - Báº£ng lÆ°Æ¡ng, thu nháº­p

        Báº¡n muá»‘n xem thÃ´ng tin nÃ o?""",
        
        "HELP_PERSONAL": """TÃ´i cÃ³ thá»ƒ há»— trá»£ thÃ´ng tin liÃªn quan Ä‘áº¿n thÃ´ng tin cÃ¡ nhÃ¢n cá»§a báº¡n: 
        â€¢ ğŸ‘¤ Há» tÃªn
        â€¢ ğŸ”¢ MÃ£ nhÃ¢n viÃªn  
        â€¢ ğŸ¢ PhÃ²ng ban
        â€¢ ğŸ’¼ Chá»©c vá»¥
        â€¢ ğŸ“ CÃ´ng viá»‡c

        Báº¡n muá»‘n xem thÃ´ng tin cá»¥ thá»ƒ nÃ o?""",
        
        "NGAYCONG_MON": """VÃ¢ng, Ä‘Ã¢y lÃ  dá»¯ liá»‡u cháº¥m cÃ´ng cá»§a báº¡n tá»« Ä‘áº§u thÃ¡ng Ä‘áº¿n hÃ´m nay:

    ğŸ“Š **Báº£ng cháº¥m cÃ´ng thÃ¡ng 10/2025**
        NgÃ y lÃ m viá»‡c Ca lÃ m viá»‡c Giá» vÃ o Giá» ra Giá» lÃ m Giá» tÄƒng ca Loáº¡i váº¯ng Sá»‘ giá» váº¯ng
        05/10/2025 08:00-17:00 08:00 17:40 8 0 - -
        06/10/2025 08:00-17:00 07:55 18:30 8 1 - -
        07/10/2025 08:00-17:00 - - - - PhÃ©p nÄƒm 8""",
    "NGAYCONG_TODAY": f"""VÃ¢ng, Ä‘Ã¢y lÃ  dá»¯ liá»‡u cháº¥m cÃ´ng cá»§a báº¡n ngÃ y hÃ´m nay:

        ğŸ“… **NgÃ y lÃ m viá»‡c**: {datetime.now().strftime('%d/%m/%Y')} 
        â° **Ca lÃ m viá»‡c**: 08:00 - 17:00 (nghá»‰ trÆ°a 12:00-13:00)
        ğŸŸ¢ **Giá» vÃ o**: 08:10  
        ğŸ”´ **Giá» ra**: ChÆ°a cÃ³
        ğŸ’¡ **Tráº¡ng thÃ¡i**: Äang lÃ m viá»‡c""",
                
        "NGAYCONG_YESTERDAY": """VÃ¢ng, Ä‘Ã¢y lÃ  dá»¯ liá»‡u cháº¥m cÃ´ng cá»§a báº¡n ngÃ y hÃ´m qua:

        ğŸ“… **NgÃ y lÃ m viá»‡c**: 19/10/2025 (Thá»© 4)
        â° **Ca lÃ m viá»‡c**: 08:00 - 17:00 (nghá»‰ trÆ°a 12:00-13:00)
        ğŸŸ¢ **Giá» vÃ o**: 08:15 (Trá»… 15 phÃºt)
        ğŸ”´ **Giá» ra**: 17:10
        â±ï¸ **Giá» lÃ m viá»‡c**: 7.5
        ğŸŒ™ **Giá» tÄƒng ca thá»±c táº¿**: 2
        âœ… **Giá» tÄƒng ca Ä‘Æ°á»£c duyá»‡t**: 2
        âŒ **Giá» váº¯ng**: KhÃ´ng cÃ³
        ğŸ“‹ **Loáº¡i váº¯ng**: KhÃ´ng cÃ³""",
        
        "NGAYCONG_FROMTO": """VÃ¢ng, Ä‘Ã¢y lÃ  dá»¯ liá»‡u cháº¥m cÃ´ng cá»§a báº¡n tá»« ngÃ y 05/10/2025 Ä‘áº¿n 30/10/2025:

    ğŸ“Š **Báº£ng cháº¥m cÃ´ng**
        NgÃ y lÃ m viá»‡c Ca lÃ m viá»‡c Giá» vÃ o Giá» ra Giá» lÃ m Giá» tÄƒng ca Loáº¡i váº¯ng Sá»‘ giá» váº¯ng
        05/10/2025 08:00-17:00 08:00 17:40 8 0 - -
        06/10/2025 08:00-17:00 07:55 18:30 8 1 - -
        07/10/2025 08:00-17:00 - - - - PhÃ©p nÄƒm 8
        ... (cÃ¡c ngÃ y khÃ¡c)

""","NGAYPHEPNAM_YEAR": """VÃ¢ng, Ä‘Ã¢y lÃ  dá»¯ liá»‡u chi tiáº¿t vá» ngÃ y nghá»‰ phÃ©p nÄƒm cá»§a báº¡n:

    ğŸ“‹ **PhÃ©p nÄƒm Ä‘Ã£ sá»­ dá»¥ng:**
        â€¢ ğŸ“… 05/01/2025 : 8 giá»
        â€¢ ğŸ“… 12/02/2025 : 4 giá»  
        â€¢ ğŸ“… 25/04/2025 : 8 giá»

    ğŸ“Š **Tá»•ng káº¿t:**
        â€¢ âœ… Tá»•ng Ä‘Ã£ nghá»‰ phÃ©p nÄƒm: 20 giá»
        â€¢ ğŸ¯ PhÃ©p nÄƒm cÃ²n láº¡i: 2 ngÃ y (16 giá»)""",
        
        "NGAYPHEPNAM_FROMTO": """VÃ¢ng, Ä‘Ã¢y lÃ  dá»¯ liá»‡u chi tiáº¿t vá» ngÃ y nghá»‰ phÃ©p nÄƒm tá»« ngÃ y 01/05/2025 Ä‘áº¿n 30/10/2025 cá»§a báº¡n:

    ğŸ“‹ **PhÃ©p nÄƒm trong khoáº£ng thá»i gian:**
        â€¢ ğŸ“… 05/01/2025 : 8 giá»
        â€¢ ğŸ“… 12/02/2025 : 4 giá»
        â€¢ ğŸ“… 25/04/2025 : 8 giá»

    ğŸ“Š **Tá»•ng káº¿t:**
        â€¢ âœ… Tá»•ng Ä‘Ã£ nghá»‰ phÃ©p nÄƒm: 20 giá»
        â€¢ ğŸ¯ PhÃ©p nÄƒm cÃ²n láº¡i: 2 ngÃ y (16 giá»)""",
        
        "NGAYNGHI_YEAR": """VÃ¢ng, Ä‘Ã¢y lÃ  dá»¯ liá»‡u ngÃ y nghá»‰ cá»§a báº¡n trÃªn há»‡ thá»‘ng ghi nháº­n tá»« Ä‘áº§u nÄƒm Ä‘áº¿n nay:

    ğŸ“Š **Báº£ng ngÃ y nghá»‰**
        NgÃ y lÃ m viá»‡c Ca lÃ m viá»‡c Loáº¡i váº¯ng Sá»‘ giá» váº¯ng
        05/10/2025 08:00-17:00 PhÃ©p nÄƒm 8
        06/10/2025 08:00-17:00 KhÃ´ng phÃ©p 8
        07/10/2025 08:00-17:00 PhÃ©p nÄƒm 4

"""}
    return actions.get(intent, "Xin lá»—i, tÃ´i chÆ°a hiá»ƒu yÃªu cáº§u cá»§a báº¡n. HÃ£y thá»­ láº¡i nhÃ©! ğŸ˜Š")


# =============================
# Demo CLI
# =============================
if __name__ == "__main__":
    print("ğŸ¤– TimeAI Assistant - Nháº­p 'quit' Ä‘á»ƒ thoÃ¡t\n")
    print(get_action("WELCOME"))
    print()
    
    while True:
        user_input = input("ğŸ‘¤ Báº¡n: ").strip()
        
        if user_input.lower() in ['quit', 'exit', 'thoÃ¡t']:
            print("ğŸ‘‹ Háº¹n gáº·p láº¡i báº¡n!")
            break
        
        res = build_response_with_time(user_input)
        print("\nğŸ¤– Bot:")
        print(f"- Intent: {res['intent']} (Äá»™ tin cáº­y: {res['confidence']:.1%})")
        print(f"- Time parse: {res['time']}")
        print(f"- UI message:\n{res['message']}\n")
        # if user_input:
        #     intent, confidence = predict_intent(user_input)
        #     action = get_action(intent, user_input)
            
        #     print(f"\nğŸ¤– Bot:")
        #     if intent in ["WELCOME", "HELP_INFORMATION", "HELP_PERSONAL"]:
        #         print(f"Intent: {intent} (Äá»™ tin cáº­y: {confidence:.1%})")
        #         print(f"Dá»¯ liá»‡u máº«u mÃ  data mÃ¬nh sáº½ hiá»ƒn thá»‹ lÃ :")
        #         print(f"\"\t{action}\"")
        #     else:
        #         print(f"Intent: {intent} (Äá»™ tin cáº­y: {confidence:.1%})")
        #         print(f"Dá»¯ liá»‡u máº«u mÃ  data mÃ¬nh sáº½ hiá»ƒn thá»‹ lÃ :")
        #         print(f"\"\t{action}\"")
        #     print()